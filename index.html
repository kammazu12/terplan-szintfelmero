<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Python alapok kvíz — 10. osztály</title>
  <style>
    /* Minimalista, letisztult CSS - egyszerű és jól kinéző */
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#7dd3fc;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --maxw:1100px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:linear-gradient(180deg, #07101a 0%, var(--bg) 100%);
      display:flex;
      justify-content:center;
      padding:28px 18px;
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{width:100%;max-width:var(--maxw);}
    header{display:flex;gap:18px;align-items:center;margin-bottom:18px;}
    .brand{background:linear-gradient(135deg, rgba(125,211,252,0.15), rgba(99,102,241,0.06));padding:10px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    main.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), var(--card));border-radius:var(--radius);padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    .landing{padding:18px;background:var(--glass);border-radius:10px;margin-bottom:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .landing input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    section{margin-top:14px;padding:12px;background:var(--glass);border-radius:10px;}
    h2{font-size:15px;margin:6px 0}
    label.question{display:block;margin:10px 0;font-size:14px}
    .choices{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .choice{display:flex;gap:8px;align-items:center}
    input[type=radio], input[type=checkbox]{transform:scale(1.05)}
    input[type=text], textarea, select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;outline:none;resize:vertical;min-height:40px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{background:var(--accent);color:#042029;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
    .result{margin-top:12px;padding:10px;border-radius:8px;background:rgba(125,211,252,0.06);color:var(--accent);font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
    aside.side{padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:10px;font-size:13px;color:var(--muted)}
    footer{color:var(--muted);font-size:13px;margin-top:12px}
    details[open] summary::after{content:" (bezárható)";font-size:12px;color:var(--muted)}
    summary{cursor:pointer}
    .wrong{color:#ffb4b4}
    .correct{color:#b7f5d0}
    .question-meta{font-size:12px;color:var(--muted)}
    .hidden{display:none}
    .pager{display:flex;justify-content:space-between;margin-top:12px}
    .required-star{color:#ffb3b3;margin-left:6px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left}
    .small{font-size:12px;color:var(--muted)}
    .teacher-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{background:rgba(125,211,252,0.06);color:var(--accent);padding:4px 8px;border-radius:8px;font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{text-align:right}
    .small-btn{padding:6px 8px;border-radius:8px;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><strong>Python alapok — 10. osztály</strong></div>
      <div>
        <h1>33 kérdéses vegyes kvíz</h1>
      </div>
    </header>

    <main class="card">
      <div class="grid">
        <div>
          <!-- Landing / registration -->
          <div class="landing" id="landing">
            <div><strong>Regisztráció</strong><div class="question-meta">Add meg a saját neved (kötelező)</div></div>
            <div style="flex:1;margin:0 12px"><input id="studentName" type="text" placeholder="Pl.: Kovács Anna" /></div>
            <div><button id="startBtn">Kezdés</button></div>
          </div>

          <!-- TEACHER SECTION (hidden until teacher name entered) -->
          <section id="teacher-section" class="hidden">
            <h2>Tanári felület — Javító</h2>
            <p class="small">A beérkezett válaszok (localStorage) listája — automatikus kiértékelés 1–20-ig. Feltölthetsz diák JSON-okat is.</p>

            <div class="teacher-controls" style="margin-top:8px">
              <input type="file" id="fileInput" accept=".json,application/json" multiple />
              <button id="processFilesBtn" class="small-btn">Feldolgoz</button>
              <button id="refreshDbBtn" class="ghost small-btn">Frissít adatbázisból</button>
              <button id="exportAllCsv" class="ghost small-btn">Export CSV</button>
              <button id="exportAllJson" class="ghost small-btn">Export JSON</button>
              <div class="badge" id="subCount">0 beküldés</div>
            </div>

            <div id="teacherTableWrap" style="margin-top:12px">
              <table id="teacherTable" class="mono">
                <thead>
                  <tr><th>Diák</th><th>Beküldés ideje</th><th>MC (20)</th><th>%</th><th>Man. össz</th><th>Teljes</th><th>Műveletek</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div id="teacherDetails" class="hidden" style="margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)">
              <h3 id="td-student">Részletek</h3>
              <div id="td-meta" class="small"></div>
              <div id="td-answers" style="margin-top:10px;max-height:300px;overflow:auto;font-size:13px"></div>

              <hr style="opacity:.06;margin:10px 0" />

              <div class="small">Manuális pontozás (36–45): adj pontokat 0–10 skálán minden feladatra, majd mentsd.</div>
              <div id="manualGrades" style="margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
                <!-- inputs inserted dynamically -->
              </div>

              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <textarea id="teacherComment" placeholder="Megjegyzés (opcionális)" style="flex:1;min-height:60px"></textarea>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <button id="saveManual" style="white-space:nowrap">Mentés</button>
                  <button id="downloadThis" class="ghost">Letöltés (JSON)</button>
                </div>
              </div>

              <div style="margin-top:8px" id="td-save-msg" class="small"></div>
            </div>
          </section>

          <!-- QUIZ FORM START (student view) -->
          <form id="quizForm">
            <!-- I. Feleletválasztós (20) -->
            <section id="mc-section" class="hidden">
              <h2>I. Feleletválasztós kérdések <span class="required-star">*</span></h2>

              <!-- (questions 1..20) -->
              <!-- 1 -->
              <label class="question">1. Melyik helyes változónév Pythonban?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q1" value="a"> a) 2adat</label>
                <label class="choice"><input type="radio" name="q1" value="b"> b) adat_2</label>
                <label class="choice"><input type="radio" name="q1" value="c"> c) adat-2</label>
                <label class="choice"><input type="radio" name="q1" value="d"> d) print</label>
              </div>

              <!-- 2 -->
              <label class="question">2. Mi lesz a <code>print(type(3.14))</code> kimenete?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q2" value="a"> a) &lt;class 'int'&gt;</label>
                <label class="choice"><input type="radio" name="q2" value="b"> b) &lt;class 'float'&gt;</label>
                <label class="choice"><input type="radio" name="q2" value="c"> c) &lt;class 'double'&gt;</label>
                <label class="choice"><input type="radio" name="q2" value="d"> d) &lt;class 'str'&gt;</label>
              </div>

              <!-- 3 -->
              <label class="question">3. Melyik operátor végzi az egész osztást?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q3" value="a"> a) /</label>
                <label class="choice"><input type="radio" name="q3" value="b"> b) //</label>
                <label class="choice"><input type="radio" name="q3" value="c"> c) %</label>
                <label class="choice"><input type="radio" name="q3" value="d"> d) **</label>
              </div>

              <!-- 4 -->
              <label class="question">4. Mit ad vissza a <code>len("Python")</code>?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q4" value="a"> a) 5</label>
                <label class="choice"><input type="radio" name="q4" value="b"> b) 6</label>
                <label class="choice"><input type="radio" name="q4" value="c"> c) "Python"</label>
                <label class="choice"><input type="radio" name="q4" value="d"> d) Hibaüzenet</label>
              </div>

              <!-- 5 -->
              <label class="question">5. Melyik állítás igaz?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q5" value="a"> a) A stringek módosíthatók.</label>
                <label class="choice"><input type="radio" name="q5" value="b"> b) A listák módosíthatók.</label>
                <label class="choice"><input type="radio" name="q5" value="c"> c) A tuple elemei szabadon cserélhetők.</label>
                <label class="choice"><input type="radio" name="q5" value="d"> d) A szótár (dict) nem tartalmazhat kulcs-érték párokat.</label>
              </div>

              <!-- 6 -->
              <label class="question">6. Mit ad a <code>3 ** 2</code>?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q6" value="a"> a) 6</label>
                <label class="choice"><input type="radio" name="q6" value="b"> b) 9</label>
                <label class="choice"><input type="radio" name="q6" value="c"> c) 8</label>
                <label class="choice"><input type="radio" name="q6" value="d"> d) 32</label>
              </div>

              <!-- 7 -->
              <label class="question">7. Hogyan írjuk helyesen a logikai értékeket Pythonban?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q7" value="a"> a) TRUE, FALSE</label>
                <label class="choice"><input type="radio" name="q7" value="b"> b) true, false</label>
                <label class="choice"><input type="radio" name="q7" value="c"> c) True, False</label>
                <label class="choice"><input type="radio" name="q7" value="d"> d) 1, 0</label>
              </div>

              <!-- 8 -->
              <label class="question">8. Mit ad <code>10 % 3</code>?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q8" value="a"> a) 3</label>
                <label class="choice"><input type="radio" name="q8" value="b"> b) 1</label>
                <label class="choice"><input type="radio" name="q8" value="c"> c) 0.333...</label>
                <label class="choice"><input type="radio" name="q8" value="d"> d) 30</label>
              </div>

              <!-- 9 -->
              <label class="question">9. Melyik függvény alakít át egész számmá?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q9" value="a"> a) str()</label>
                <label class="choice"><input type="radio" name="q9" value="b"> b) int()</label>
                <label class="choice"><input type="radio" name="q9" value="c"> c) float()</label>
                <label class="choice"><input type="radio" name="q9" value="d"> d) chr()</label>
              </div>

              <!-- 10 -->
              <label class="question">10. Mit ír ki a kód lefutás után? <pre>szam = 5<br/>print(szam == 5)</pre></label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q10" value="a"> a) Igaz értéket</label>
                <label class="choice"><input type="radio" name="q10" value="b"> b) 5</label>
                <label class="choice"><input type="radio" name="q10" value="c"> c) Hibaüzenet</label>
                <label class="choice"><input type="radio" name="q10" value="d"> d) szam</label>
              </div>

              <!-- 11 -->
              <label class="question">11. Melyik a helyes <code>if</code> szerkezet?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q11" value="a"> a) if szam = 5: ...</label>
                <label class="choice"><input type="radio" name="q11" value="b"> b) if szam == 5: ...</label>
                <label class="choice"><input type="radio" name="q11" value="c"> c) if szam := 5: ...</label>
                <label class="choice"><input type="radio" name="q11" value="d"> d) if szam =&gt; 5: ...</label>
              </div>

              <!-- 12 -->
              <label class="question">12. Mit ad vissza: <code>"alma" + "fa"</code>?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q12" value="a"> a) "alma fa"</label>
                <label class="choice"><input type="radio" name="q12" value="b"> b) "almafa"</label>
                <label class="choice"><input type="radio" name="q12" value="c"> c) alma+fa</label>
                <label class="choice"><input type="radio" name="q12" value="d"> d) Hibaüzenet</label>
              </div>

              <!-- 13 -->
              <label class="question">13. Hogyan hozunk létre üres listát?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q13" value="a"> a) lista = ()</label>
                <label class="choice"><input type="radio" name="q13" value="b"> b) lista = []</label>
                <label class="choice"><input type="radio" name="q13" value="c"> c) lista = {}</label>
                <label class="choice"><input type="radio" name="q13" value="d"> d) lista = ""</label>
              </div>

              <!-- 14 -->
              <label class="question">14. Mi lesz a következő kód kimenete? <pre>for i in range(3):<br/>    print(i)</pre></label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q14" value="a"> a) 1 2 3</label>
                <label class="choice"><input type="radio" name="q14" value="b"> b) 0 1 2</label>
                <label class="choice"><input type="radio" name="q14" value="c"> c) 0 1 2 3</label>
                <label class="choice"><input type="radio" name="q14" value="d"> d) 3 2 1</label>
              </div>

              <!-- 15 -->
              <label class="question">15. Hogyan kell függvényt definiálni?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q15" value="a"> a) def fuggveny:</label>
                <label class="choice"><input type="radio" name="q15" value="b"> b) def fuggveny():</label>
                <label class="choice"><input type="radio" name="q15" value="c"> c) function fuggveny():</label>
                <label class="choice"><input type="radio" name="q15" value="d"> d) fuggveny def():</label>
              </div>

              <!-- 16 -->
              <label class="question">16. Mi a <code>break</code> utasítás szerepe ciklusban?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q16" value="a"> a) Megszakítja a ciklust.</label>
                <label class="choice"><input type="radio" name="q16" value="b"> b) Újraindítja a ciklust.</label>
                <label class="choice"><input type="radio" name="q16" value="c"> c) Egy elemet átugrik.</label>
                <label class="choice"><input type="radio" name="q16" value="d"> d) Várakoztatja a programot.</label>
              </div>

              <!-- 17 -->
              <label class="question">17. Mi a <code>continue</code> utasítás szerepe ciklusban?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q17" value="a"> a) Megállítja a ciklust.</label>
                <label class="choice"><input type="radio" name="q17" value="b"> b) A következő iterációra ugrik.</label>
                <label class="choice"><input type="radio" name="q17" value="c"> c) Visszaállítja a ciklust az elejére.</label>
                <label class="choice"><input type="radio" name="q17" value="d"> d) Hibát okoz.</label>
              </div>

              <!-- 18 -->
              <label class="question">18. Hogyan nyitunk meg fájlt olvasásra?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q18" value="a"> a) open("adat.txt")</label>
                <label class="choice"><input type="radio" name="q18" value="b"> b) open("adat.txt", "r")</label>
                <label class="choice"><input type="radio" name="q18" value="c"> c) file("adat.txt")</label>
                <label class="choice"><input type="radio" name="q18" value="d"> d) read("adat.txt")</label>
              </div>

              <!-- 19 -->
              <label class="question">19. Mit ad vissza a <code>len([])</code>?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q19" value="a"> a) 1</label>
                <label class="choice"><input type="radio" name="q19" value="b"> b) 0</label>
                <label class="choice"><input type="radio" name="q19" value="c"> c) None</label>
                <label class="choice"><input type="radio" name="q19" value="d"> d) Hibaüzenet</label>
              </div>

              <!-- 20 -->
              <label class="question">20. Mit csinál a <code>print("Python"[0])</code>?</label>
              <div class="choices">
                <label class="choice"><input type="radio" name="q20" value="a"> a) Kiírja: "P"</label>
                <label class="choice"><input type="radio" name="q20" value="b"> b) Kiírja: "y"</label>
                <label class="choice"><input type="radio" name="q20" value="c"> c) Kiírja: "Python"</label>
                <label class="choice"><input type="radio" name="q20" value="d"> d) Hibaüzenet</label>
              </div>

              <div class="pager"><div></div><div><button type="button" id="toFill">Tovább a behelyettesítéshez</button></div></div>
            </section>

            <!-- II. Behelyettesítés / Kódkiegészítés (15) -->
            <section id="fill-section" class="hidden">
              <h2>II. Behelyettesítés / Kódkiegészítés <span class="required-star">*</span></h2>

              <!-- 21..35 inputs -->
              <label class="question">21. Melyik szimbólum jelöli Pythonban a maradékképzést?</code></label>
              <input type="text" name="q21">
              <label class="question">22. Mennyi a <code>(4 - 3 // 2 + 1)</code> művelet eredménye?</label><input type="text" name="q22">
              <label class="question">23. Mit ír ki az alábbi kód? <br>
                <pre><code>x = 5
y = 10
if (x + 5) > y:
    x = y
else:
    x = x + y
print(x)</pre></code>
</label><input type="text" name="q23">
              <label class="question">24. Írd le saját szavaiddal, mi a különbség a ... és a pass kulcsszó között!</label><input type="text" name="q24">
              <label class="question">25. Mi az egész szám típus neve Pythonban?<label><input type="text" name="q25">
              <label class="question">26. Mi az alábbi érték típusa: <i>"123321"</i>?</label><input type="text" name="q26">
              <label class="question">27. Mi az alábbi érték típusa: <i>123321</i>?</label><input type="text" name="q27" >
              <label class="question">28. Mi az alábbi érték típusa: <i>123.321</i>?</label><input type="text" name="q28">
              <label class="question">29. Mi az alábbi érték típusa: <i>[1, 2, 3, 3, 2, 1]</i>?</label><input type="text" name="q29">
              <label class="question">30. Mi az alábbi érték típusa: <i>-123_321</i>?</label><input type="text" name="q30">

              <div class="pager">
                <button type="button" id="toCode">Tovább a kódoláshoz</button>
              </div>
            </section>

            <!-- III. Rövid programíró feladatok (10) -->
            <section id="code-section" class="hidden">
              <h2>III. Rövid programíró feladatok <span class="required-star">*</span></h2>
              <h3>Figyelj a Python szintaktikára!</h3>

              <!-- 36..45 textareas -->
              <label class="question">31. Írj egy programot, ami kiírja a teljes nevedet!</label><textarea name="q31"></textarea>
              <label class="question">32. Írj egy programot, ami bekér a felhasználótól egy számot és kiírja ennek a dupláját!</label><textarea name="q32"></textarea>
              <label class="question">33. Írj egy programot, ami bekér a felhasználótól egy számot és kiírja, hogy a szám páros vagy páratlan!</label><textarea name="q33"></textarea>

              <div class="pager">
                <button type="button" id="finishBtn">Befejezés</button>
              </div>
            </section>

            <div id="resultArea"></div>
          </form>
          <!-- QUIZ FORM END -->
        </div>
      </div>

    </main>
  </div>

  <script>
    // helyes válaszok a feleletválasztósokhoz
    const correct = {
      q1:'b',q2:'b',q3:'b',q4:'b',q5:'b',q6:'b',q7:'c',q8:'b',q9:'b',q10:'a',
      q11:'b',q12:'b',q13:'b',q14:'b',q15:'b',q16:'a',q17:'b',q18:'b',q19:'b',q20:'a'
    };

    // Elemi DOM
    const landing = document.getElementById('landing');
    const startBtn = document.getElementById('startBtn');
    const mcSection = document.getElementById('mc-section');
    const fillSection = document.getElementById('fill-section');
    const codeSection = document.getElementById('code-section');
    const resultArea = document.getElementById('resultArea');

    // teacher elems
    const teacherSection = document.getElementById('teacher-section');
    const fileInput = document.getElementById('fileInput');
    const processFilesBtn = document.getElementById('processFilesBtn');
    const teacherTableBody = document.querySelector('#teacherTable tbody');
    const subCountBadge = document.getElementById('subCount');
    const teacherDetails = document.getElementById('teacherDetails');
    const tdStudent = document.getElementById('td-student');
    const tdMeta = document.getElementById('td-meta');
    const tdAnswers = document.getElementById('td-answers');
    const manualGrades = document.getElementById('manualGrades');
    const teacherComment = document.getElementById('teacherComment');
    const saveManual = document.getElementById('saveManual');
    const downloadThis = document.getElementById('downloadThis');
    const exportAllCsv = document.getElementById('exportAllCsv');
    const exportAllJson = document.getElementById('exportAllJson');
    const refreshDbBtn = document.getElementById('refreshDbBtn');

    // in-memory state (mirrors DB)
    window.submissions = [];

    // localStorage key
    const DB_KEY = 'python_quiz_submissions_v1';

    // ---------- DB helpers (localStorage "adatbázis") ----------
    function loadDB(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return [];
        return arr;
      }catch(e){
        console.error('DB load error', e);
        return [];
      }
    }

    function saveDB(arr){
      try{
        localStorage.setItem(DB_KEY, JSON.stringify(arr));
      }catch(e){
        console.error('DB save error', e);
      }
    }

    function pushToDB(sub){
      const db = loadDB();
      db.push(sub);
      saveDB(db);
      return sub.id;
    }

    function deleteFromDBById(id){
      let db = loadDB();
      db = db.filter(s=>s.id !== id);
      saveDB(db);
      return db;
    }

    function replaceInDB(id, newObj){
      let db = loadDB();
      db = db.map(s=> s.id === id ? newObj : s);
      saveDB(db);
      return db;
    }

    // ---------- Utility ----------
    function makeId(){
      return `${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    // ---------- Save submission (student flow) ----------
    function collectAllAnswers(){
      const answers = {};
      // mc
      for(let i=1;i<=20;i++){
        const radios = document.getElementsByName('q'+i);
        const checked = Array.from(radios).find(r=>r.checked);
        answers['q'+i] = checked ? checked.value : null;
      }
      // fill
      for(let i=21;i<=30;i++){
        const el = document.querySelector('[name="q'+i+'"]');
        answers['q'+i] = el && el.value ? el.value.trim() : null;
      }
      // code
      for(let i=31;i<=33;i++){
        const el = document.querySelector('[name="q'+i+'"]');
        answers['q'+i] = el && el.value ? el.value.trim() : null;
      }
      return answers;
    }

    function computeMCStats(answers){
      let mcCorrect = 0; const mcWrong = [];
      for(let i=1;i<=20;i++){
        const v = answers['q'+i] || null;
        if(v === correct['q'+i]) mcCorrect++; else mcWrong.push(i);
      }
      return {mcCorrect, mcWrong, mcPercent: Math.round((mcCorrect/20)*100)};
    }

    function saveSubmissionFromStudent(){
      const answers = collectAllAnswers();
      const meta = { generated: new Date().toISOString(), student: window.studentName || '(név hiányzik)', source:'local' };
      const stats = computeMCStats(answers);
      const sub = {
        id: makeId(),
        meta,
        answers,
        mcCorrect: stats.mcCorrect,
        mcWrong: stats.mcWrong,
        mcPercent: stats.mcPercent,
        manual:{scores:{}, total:null, comment:null}
      };
      pushToDB(sub);
      // update in-memory copy and UI if teacher is viewing
      window.submissions = loadDB();
      refreshTeacherTable();
      return sub;
    }

    // ---------- UI flows ----------
    startBtn.addEventListener('click',()=>{
      const name = document.getElementById('studentName').value.trim();
      if(!name){ alert('Kérlek add meg a neved!'); return; }

      // TEACHER CHECK: exact match
      if(name === 'Tóth Alex GVM'){
        landing.classList.add('hidden');
        teacherSection.classList.remove('hidden');
        mcSection.classList.add('hidden');
        fillSection.classList.add('hidden');
        codeSection.classList.add('hidden');
        window.isTeacher = true;
        window.studentName = name;
        window.answers = {};
        // load DB into memory and refresh
        window.submissions = loadDB();
        refreshTeacherTable();
        return;
      }

      // normal student flow
      landing.classList.add('hidden');
      mcSection.classList.remove('hidden');
      window.studentName = name;
      window.isTeacher = false;
      window.answers = {};
    });

    // STUDENT NAVIGATION
    document.getElementById('toFill').addEventListener('click', ()=>{
      for(let i=1;i<=20;i++){
        const radios = document.getElementsByName('q'+i);
        if(!Array.from(radios).some(r=>r.checked)){ alert('Kérlek válaszolj minden feleletválasztós kérdésre (1-20).'); return; }
      }
      for(let i=1;i<=20;i++){
        const radios = document.getElementsByName('q'+i);
        const checked = Array.from(radios).find(r=>r.checked);
        window.answers['q'+i] = checked ? checked.value : null;
      }
      mcSection.classList.add('hidden');
      fillSection.classList.remove('hidden');
      window.scrollTo(0,0);
    });

    document.getElementById('toCode').addEventListener('click',()=>{
      for(let i=21;i<=30;i++){ const el = document.querySelector('[name="q'+i+'"]'); if(!el || !el.value.trim()){ alert('Kérlek válaszolj minden behelyettesítéses kérdésre (21-30).'); return; } }
      for(let i=21;i<=30;i++) window.answers['q'+i] = document.querySelector('[name="q'+i+'"]').value.trim();
      fillSection.classList.add('hidden'); codeSection.classList.remove('hidden'); window.scrollTo(0,0);
    });

    document.getElementById('finishBtn').addEventListener('click',()=>{
      for(let i=31;i<=33;i++){ const el = document.querySelector('[name="q'+i+'"]'); if(!el || !el.value.trim()){ alert('Kérlek válaszolj minden programíró feladatra (31-33).'); return; } }
      for(let i=31;i<=33;i++) window.answers['q'+i] = document.querySelector('[name="q'+i+'"]').value.trim();

      // Automatikus javítás és mentés a "DB"-be
      const sub = saveSubmissionFromStudent();
      mcScore(sub);
      resultArea.scrollIntoView({behavior:'smooth'});

      // ...ellenőrzések, válaszok összegyűjtése
      const payload = { meta: { student: window.studentName }, answers: window.answers };

      fetch("https://script.google.com/macros/s/AKfycbwPNsnW86GymGhGvT57EKe0BFuFUnvOCUfQ1jaYQlLO3bsaHm_5vcZgsBCGW90AKR5sqA/exec", {
          method: "POST",
          body: JSON.stringify(payload)
        })

      .then(res => res.json())
      .then(data => console.log("Beküldve:", data))
      .catch(err => console.error("Hiba a beküldésnél:", err));

      alert("Válaszaid elküldve!");


      // informáljuk a diákot
      resultArea.innerHTML += `<div class="small" style="margin-top:8px;color:var(--muted)">Válaszod elmentve az oldal helyi adatbázisába (localStorage). Ha szeretnéd, letöltheted JSON-ként is.</div>`;
    });

    // automatikus javítás (feleletválasztók) - képes megkapni submission objektumot is
    function mcScore(sub){
      let correctCount=0; const wrong=[];
      if(sub && sub.mcCorrect !== undefined){
        correctCount = sub.mcCorrect;
        wrong.push(...sub.mcWrong);
      }else{
        // fallback: use window.answers
        for(let i=1;i<=20;i++){
          const a = window.answers['q'+i];
          if(a===correct['q'+i]){ correctCount++; } else wrong.push(i);
        }
      }
      const percent = Math.round((correctCount/20)*100);
      resultArea.innerHTML = `<div class="result">Automatikus javítás (feleletválasztók): ${correctCount}/20 (${percent}%)</div>`;
      if(wrong.length) resultArea.innerHTML += `<div style="margin-top:8px;color:var(--muted)">Hibás kérdések: ${wrong.join(', ')}</div>`;
      resultArea.innerHTML += `<div style="margin-top:10px;color:var(--muted)">A teljes válaszcsomag letölthető JSON-ként.</div>`;
    }

    document.getElementById('gradeBtn').addEventListener('click', ()=>{
      for(let i=1;i<=20;i++){ const radios = document.getElementsByName('q'+i); const checked = Array.from(radios).find(r=>r.checked); window.answers['q'+i] = checked ? checked.value : null; }
      mcScore();
    });

    // student JSON download (mentés is)
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      // collect and ensure window.answers populated
      for(let i=1;i<=20;i++){ const radios = document.getElementsByName('q'+i); const checked = Array.from(radios).find(r=>r.checked); window.answers['q'+i] = checked ? checked.value : (window.answers['q'+i] || null); }
      for(let i=21;i<=30;i++){ const el = document.querySelector('[name="q'+i+'"]'); window.answers['q'+i] = el && el.value ? el.value.trim() : (window.answers['q'+i] || null); }
      for(let i=31;i<=33;i++){ const el = document.querySelector('[name="q'+i+'"]'); window.answers['q'+i] = el && el.value ? el.value.trim() : (window.answers['q'+i] || null); }

      const payload = { meta:{generated:new Date().toISOString(), quiz:"Python alapok - 33", student: window.studentName || null}, answers: window.answers || {} };

      // Save to DB as well (avoid duplicate identical entries: still save, it's intentional)
      const stats = computeMCStats(payload.answers);
      const sub = {
        id: makeId(),
        meta: payload.meta,
        answers: payload.answers,
        mcCorrect: stats.mcCorrect,
        mcWrong: stats.mcWrong,
        mcPercent: stats.mcPercent,
        manual:{scores:{}, total:null, comment:null}
      };
      pushToDB(sub);
      window.submissions = loadDB();
      refreshTeacherTable();

      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=(window.studentName?window.studentName.replace(/\s+/g,'_'):'student')+"_answers.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      alert('Válaszod elmentve és letöltés indítva.');
    });

    /* ------------------------
       TEACHER: file processing & DB sync
       ------------------------ */
    processFilesBtn.addEventListener('click', ()=> {
      const files = fileInput.files;
      if(!files || files.length===0){ alert('Válassz legalább egy JSON fájlt.'); return; }
      const readers = [];
      for(const f of files){
        readers.push(readFileAsText(f).then(text=>{
          try{ return { parsed: JSON.parse(text), filename: f.name }; } catch(e){ return {__invalid__:true, name:f.name, raw:text}; }
        }));
      }
      Promise.all(readers).then(results=>{
        let added=0;
        for(const doc of results){
          if(doc && doc.__invalid__){ console.warn('Nem érvényes JSON:', doc.name); continue; }
          const parsed = doc.parsed;
          const meta = parsed.meta || {};
          const answers = parsed.answers || {};
          const student = meta.student || '(név hiányzik)';
          const generated = meta.generated || new Date().toISOString();
          // compute MC stats
          let mcCorrect=0; const mcWrong=[];
          for(let i=1;i<=20;i++){
            const v = answers['q'+i] || null;
            if(v === correct['q'+i]) mcCorrect++; else mcWrong.push(i);
          }
          const mcPercent = Math.round((mcCorrect/20)*100);
          // compose submission
          const sub = {
            id: makeId(),
            meta:{student,generated,sourceFile: doc.filename || meta.sourceFile || 'uploaded'},
            answers,
            mcCorrect, mcWrong, mcPercent,
            manual:{scores:{}, total:null, comment:null}
          };
          pushToDB(sub);
          added++;
        }
        if(added===0) alert('Nem találtam feldolgozható beküldést a fájlokban. Ellenőrizd a JSON szerkezetét.');
        else {
          window.submissions = loadDB();
          refreshTeacherTable();
          alert(added + ' beküldés feldolgozva és elmentve az adatbázisba.');
        }
      });
    });

    function readFileAsText(file){
      return new Promise((res,rej)=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.onerror = ()=>rej(fr.error);
        fr.readAsText(file);
      });
    }

    refreshDbBtn.addEventListener('click', ()=>{
      window.submissions = loadDB();
      refreshTeacherTable();
      alert('Adatbázis frissítve.');
    });

    // Refresh teacher table from window.submissions
    function refreshTeacherTable(){
      teacherTableBody.innerHTML='';
      window.submissions.forEach((s, idx)=>{
        const tr = document.createElement('tr');
        const student = s.meta.student || '(név hiányzik)';
        const generated = s.meta.generated || '';
        const mc = `${s.mcCorrect}/20`;
        const pct = s.mcPercent + '%';
        const man = s.manual.total !== null ? s.manual.total : '-';
        const total = computeTotalForDisplay(s);
        tr.innerHTML = `<td class="mono">${escapeHtml(student)}</td>
                        <td class="small">${escapeHtml(generated)}</td>
                        <td>${mc}</td>
                        <td>${pct}</td>
                        <td>${man}</td>
                        <td class="right">${total}</td>
                        <td>
                          <button data-idx="${idx}" class="viewBtn small-btn">Megnéz</button>
                          <button data-id="${s.id}" class="delBtn ghost small-btn">Töröl</button>
                        </td>`;
        teacherTableBody.appendChild(tr);
      });
      subCountBadge.textContent = window.submissions.length + ' beküldés';
      // attach view handlers
      Array.from(document.getElementsByClassName('viewBtn')).forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          const idx = +btn.getAttribute('data-idx');
          openDetails(idx);
        });
      });
      // attach delete handlers
      Array.from(document.getElementsByClassName('delBtn')).forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          const id = btn.getAttribute('data-id');
          if(!confirm('Biztosan törlöd ezt a beküldést az adatbázisból?')) return;
          deleteFromDBById(id);
          window.submissions = loadDB();
          refreshTeacherTable();
        });
      });
    }

    function computeTotalForDisplay(s){
      const mcPoints = s.mcCorrect; // 0-20
      const manualTotal = s.manual.total !== null ? s.manual.total : 0;
      const total = mcPoints + manualTotal; // egyszerű aggregáció
      return total;
    }

    function openDetails(idx){
      const s = window.submissions[idx];
      tdStudent.textContent = s.meta.student;
      tdMeta.innerHTML = `Beküldés ideje: <span class="mono">${escapeHtml(s.meta.generated || '')}</span> — Forrás fájl: <span class="mono">${escapeHtml(s.meta.sourceFile || '-')}</span>`;
      // show answers neatly
      let html = '<strong>Feleletválasztós (1-20):</strong><div class="small">';
      for(let i=1;i<=20;i++){
        const a = s.answers['q'+i] || '';
        const ok = (a === correct['q'+i]);
        html += `<div>${i}. <span class="${ok? 'correct':'wrong'}">${escapeHtml(a || '-')}</span></div>`;
      }
      html += '</div><hr style="opacity:.06"/>';
      html += '<strong>Behelyettesítés (21-35):</strong><div class="small">';
      for(let i=21;i<=30;i++){ html += `<div>${i}. ${escapeHtml(s.answers['q'+i] || '')}</div>`; }
      html += '</div><hr style="opacity:.06"/>';
      html += '<strong>Kód (36-45):</strong><div class="small">';
      for(let i=31;i<=33;i++){ html += `<div>${i}. <pre style="white-space:pre-wrap;margin:0">${escapeHtml(s.answers['q'+i] || '')}</pre></div>`; }
      html += '</div>';
      tdAnswers.innerHTML = html;

      // manual grades inputs
      manualGrades.innerHTML = '';
      for(let i=31;i<=33;i++){
        const existing = s.manual.scores && (s.manual.scores[i]? s.manual.scores[i] : '');
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<label class="small">${i}:</label><input type="number" min="0" max="10" step="1" data-q="${i}" value="${existing}" />`;
        manualGrades.appendChild(wrapper);
      }
      teacherComment.value = s.manual.comment || '';
      teacherDetails.classList.remove('hidden');

      // save handler (rebind for this open)
      saveManual.onclick = ()=> {
        const inputs = manualGrades.querySelectorAll('input[data-q]');
        let sum=0; const scores={};
        inputs.forEach(inp=>{
          const q = inp.getAttribute('data-q');
          const v = inp.value.trim();
          const num = v === '' ? 0 : Math.max(0, Math.min(10, Number(v)));
          scores[q] = num;
          sum += num;
        });
        s.manual.scores = scores;
        s.manual.total = sum;
        s.manual.comment = teacherComment.value.trim() || null;
        // write back to DB
        replaceInDB(s.id, s);
        tdSaveMsg('Mentve.');
        window.submissions = loadDB();
        refreshTeacherTable();
      };

      // download selected submission
      downloadThis.onclick = ()=>{
        const payload = { meta: s.meta, answers: s.answers, mcCorrect: s.mcCorrect, mcWrong: s.mcWrong, manual: s.manual };
        const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=(s.meta.student? s.meta.student.replace(/\s+/g,'_'):'student')+"_graded.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      };
    }

    function tdSaveMsg(text){
      const el = document.getElementById('td-save-msg');
      el.textContent = text;
      setTimeout(()=>el.textContent = '', 3000);
    }

    // Export aggregated CSV / JSON
    exportAllJson.addEventListener('click', ()=>{
      const db = loadDB();
      if(db.length===0){ alert('Nincsenek beküldések.'); return; }
      const blob = new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='all_submissions.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    exportAllCsv.addEventListener('click', ()=>{
      const db = loadDB();
      if(db.length===0){ alert('Nincsenek beküldések.'); return; }
      const rows = [];
      const header = ['student','generated','mcCorrect','mcPercent','manualTotal','total','comment','answers_json'];
      rows.push(header.join(','));
      db.forEach(s=>{
        const mc = s.mcCorrect;
        const pct = s.mcPercent;
        const man = s.manual.total !== null ? s.manual.total : '';
        const total = computeTotalForDisplay(s);
        const comment = s.manual.comment ? `"${String(s.manual.comment).replace(/\"/g,'""')}"` : '';
        const answersStr = `"${JSON.stringify(s.answers).replace(/\"/g,'""')}"`;
        const row = [ `"${s.meta.student.replace(/\"/g,'""')}"`, `"${s.meta.generated}"`, mc, pct, man, total, comment, answersStr ];
        rows.push(row.join(','));
      });
      const csv = rows.join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='submissions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // initial UI tidy: hide teacher area until login
    teacherSection.classList.add('hidden');

  </script>
</body>
</html>
